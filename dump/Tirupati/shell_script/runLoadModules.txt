# export file configurations for hadoop and yarn environment
 
export SPARK_MAJOR_VERSION=2
export HADOOP_CONF_DIR=/etc/hadoop/conf:/etc/hive/conf:/etc/hbase/conf
export YARN_CONF_DIR=/etc/hadoop/conf:/etc/hive/conf:/etc/hbase/conf

# set the spark environment classpath
 
APP_SPARK_CLASSPATH=/usr/hdp/current/spark-client/lib/datanucleus-api-jdo-3.2.6.jar:/usr/hdp/current/spark-client/lib/datanucleus-core-3.2.10.jar:/usr/hdp/current/spark-client/lib/datanucleus-rdbms-3.2.9.jar:/usr/hdp/current/spark-client/lib/spark-assembly-1.6.2.2.5.0.2-3-hadoop2.7.3.2.5.0.2-3.jar:/etc/hadoop/conf


# command list to be passed to load jobs for each transformations 
cmdList="transformation1 transformation2 transformation3"

#set the lod directory path 
LOGDIR=./logs

# pass individual job names to execute if no argument passed then all modules will get loaded
if [ $# -eq 0 ]
 then
        runOption="$cmdList"
else
        runOption="$1"
fi
 
# for each of the jobs set the log file name with timestamp and call the main scala class to execute
for metric_name in `echo $runOption`
do
 
        echo "Start processing $metric_name";
        LOGFILE=$metric_name.`date '+%Y%m%d.%H%M%S'`.log
 
        case ${metric_name} in
 
                "transformation1")
                        MAIN_CLASS=com.ge.loadmodules.dataload.SampleMeasure
                        ;;
 
 
                "transformation2")
                        MAIN_CLASS=com.ge.loadmodules.dataload.SampleMeasure2
                                                ;;
 
 
                *)
			# exit with error message if wrong argment is passed
                        echo "Invalid argument $metric_name passed "
                        echo "Usage $0 runOption "
                        echo "runOption = $cmdList "
                        exit 1
                        ;;
 
        esac


#run the spark submit and capture the logs in log directory
/usr/bin/spark-submit --driver-class-path $APP_SPARK_CLASSPATH --class $MAIN_CLASS --master yarn --deploy-mode client --executor-memory 2G --num-executors 6 --files /etc/hive/conf/hive-site.xml --properties-file ./config/application.conf ./build/libs/data-loadmodules-1.0.0.jar 2>&1 | tee $LOGDIR/LOGFILE
 
        echo "Completed processing $metric_name";
done
 